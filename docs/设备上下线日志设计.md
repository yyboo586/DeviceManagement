# 设备上下线日志设计

## 概述

设备上下线日志用于记录设备的连接状态变化，包括设备上线和下线的时间、原因、IP地址等信息。这对于设备监控、故障排查和运维管理非常重要。

## 数据库设计

### 表结构

```sql
CREATE TABLE IF NOT EXISTS `t_device_online_log` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `device_id` BIGINT(20) NOT NULL COMMENT '设备ID',
  `device_key` VARCHAR(64) NOT NULL COMMENT '设备唯一标识',
  `org_id` VARCHAR(40) NOT NULL COMMENT '组织ID',
  `event_type` TINYINT(4) NOT NULL COMMENT '事件类型(1: 上线 2: 下线)',
  `online_status` TINYINT(4) NOT NULL COMMENT '设备在线状态(1: 在线 2: 离线)',
  `ip_address` VARCHAR(45) NULL COMMENT '设备IP地址',
  `client_id` VARCHAR(64) NULL COMMENT '客户端ID',
  `reason` VARCHAR(255) NULL COMMENT '上下线原因',
  `duration` BIGINT(20) NULL DEFAULT 0 COMMENT '在线时长(秒)',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  INDEX `idx_device_id` (`device_id`),
  INDEX `idx_device_key` (`device_key`),
  INDEX `idx_org_id` (`org_id`),
  INDEX `idx_event_type` (`event_type`),
  INDEX `idx_created_at` (`created_at`),
  INDEX `idx_device_event_time` (`device_id`, `event_type`, `created_at`)
) ENGINE = InnoDB COMMENT = '设备上下线日志表';
```

### 字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键ID |
| device_id | BIGINT | 设备ID |
| device_key | VARCHAR(64) | 设备唯一标识 |
| org_id | VARCHAR(40) | 组织ID |
| event_type | TINYINT | 事件类型(1:上线 2:下线) |
| online_status | TINYINT | 设备在线状态(1:在线 2:离线) |
| ip_address | VARCHAR(45) | 设备IP地址 |
| client_id | VARCHAR(64) | 客户端ID |
| reason | VARCHAR(255) | 上下线原因 |
| duration | BIGINT | 在线时长(秒) |
| created_at | DATETIME | 创建时间 |

## 功能特性

### 1. 自动记录上下线日志

当设备状态发生变化时，系统会自动记录相应的日志：

- **设备上线**：记录上线时间、IP地址、客户端ID等信息
- **设备下线**：记录下线时间、下线原因、在线时长等信息

### 2. 日志查询功能

支持多种查询条件：
- 按组织ID查询
- 按设备ID查询
- 按事件类型查询（上线/下线）
- 按时间范围查询
- 分页查询

### 3. 在线时长统计

可以统计设备在指定时间范围内的在线时长，支持：
- 按设备统计
- 按时间范围统计
- 计算累计在线时长

## API接口

### 1. 获取设备上下线日志列表

```
GET /api/v1/device/online/log/list
```

**请求参数：**
- org_id: 组织ID（必填）
- device_id: 设备ID（可选）
- event_type: 事件类型（可选，1:上线 2:下线）
- start_time: 开始时间（可选）
- end_time: 结束时间（可选）
- page: 页码（默认1）
- page_size: 每页数量（默认10）

**响应示例：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "device_id": 1001,
        "device_key": "device_001",
        "org_id": "org_001",
        "event_type": 1,
        "online_status": 1,
        "ip_address": "192.168.1.100",
        "client_id": "client_001",
        "reason": "设备上线",
        "duration": 0,
        "created_at": "2024-01-01 10:00:00"
      }
    ],
    "total": 100,
    "page": 1
  }
}
```

### 2. 获取设备在线时长

```
GET /api/v1/device/online/duration
```

**请求参数：**
- device_id: 设备ID（必填）
- start_time: 开始时间（可选）
- end_time: 结束时间（可选）

**响应示例：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "device_id": 1001,
    "duration": 3600,
    "start_time": "2024-01-01 00:00:00",
    "end_time": "2024-01-01 23:59:59"
  }
}
```

## 使用场景

### 1. 设备监控
- 实时监控设备连接状态
- 统计设备在线率
- 分析设备连接稳定性

### 2. 故障排查
- 查看设备历史连接记录
- 分析设备异常下线原因
- 定位网络连接问题

### 3. 运维管理
- 统计设备使用时长
- 分析设备使用模式
- 优化设备维护计划

## 性能优化

### 1. 索引优化
- 为常用查询字段创建索引
- 使用复合索引提高查询效率
- 定期分析索引使用情况

### 2. 数据归档
- 定期归档历史日志数据
- 保留最近3个月的详细日志
- 长期保存统计汇总数据

### 3. 查询优化
- 使用分页查询避免大量数据返回
- 合理设置查询时间范围
- 使用缓存减少数据库查询

## 扩展功能

### 1. 告警功能
- 设备异常下线告警
- 设备长时间离线告警
- 设备连接频率异常告警

### 2. 统计分析
- 设备在线时长统计
- 设备连接频率分析
- 设备稳定性评估

### 3. 报表功能
- 设备连接状态报表
- 设备使用时长报表
- 设备故障分析报表 