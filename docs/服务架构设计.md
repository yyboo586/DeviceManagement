# 设备管理服务架构设计

## 1. 服务职责划分

### 1.1 设备管理服务（DeviceManagement）
**核心职责：**
- 产品分类管理
- 产品管理
- 物模型管理
- 设备元数据管理
- 设备接入配置
- 指令下发管理
- 设备数据存储

**物模型相关功能：**
- 物模型定义和版本管理
- 物模型模板管理
- 物模型与产品绑定
- 基于物模型的指令创建

### 1.2 设备接入服务（DeviceGateway）
**核心职责：**
- 设备连接管理
- 协议适配（MQTT/CoAP/HTTP）
- 实时通信
- 心跳检测
- 数据转发

### 1.3 身份认证服务（IdentifyService）
**核心职责：**
- 用户认证
- 组织管理
- 权限控制

## 2. 物模型在设备管理服务中的定位

### 2.1 物模型的作用
```
产品分类 → 产品 → 物模型 → 设备
```

- **产品分类**：业务分类（传感器类、控制器类）
- **产品**：具体产品（华为温度传感器）
- **物模型**：产品的能力定义
- **设备**：产品的物理实例

### 2.2 物模型管理功能

#### 物模型定义
```go
type ThingModel struct {
    ID          int64                    `json:"id"`
    ProductID   int64                    `json:"product_id"`
    Name        string                   `json:"name"`
    Version     string                   `json:"version"`
    Properties  []*ThingModelProperty    `json:"properties"`  // 属性定义
    Services    []*ThingModelService     `json:"services"`    // 服务定义
    Events      []*ThingModelEvent       `json:"events"`      // 事件定义
}
```

#### 物模型模板
```go
type ThingModelTemplate struct {
    ID          int64                    `json:"id"`
    CategoryID  int64                    `json:"category_id"`
    Name        string                   `json:"name"`
    IsSystem    bool                     `json:"is_system"`
    Properties  []*ThingModelProperty    `json:"properties"`
    Services    []*ThingModelService     `json:"services"`
    Events      []*ThingModelEvent       `json:"events"`
}
```

### 2.3 物模型API设计

```http
# 物模型管理
GET    /api/v1/device-management/orgs/{org_id}/products/{product_id}/thing-models
POST   /api/v1/device-management/orgs/{org_id}/products/{product_id}/thing-models
GET    /api/v1/device-management/orgs/{org_id}/products/{product_id}/thing-models/{thing_model_id}
PUT    /api/v1/device-management/orgs/{org_id}/products/{product_id}/thing-models/{thing_model_id}
DELETE /api/v1/device-management/orgs/{org_id}/products/{product_id}/thing-models/{thing_model_id}

# 物模型模板管理
GET    /api/v1/device-management/thing-model-templates
POST   /api/v1/device-management/orgs/{org_id}/thing-model-templates
GET    /api/v1/device-management/thing-model-templates/{template_id}

# 从模板创建物模型
POST   /api/v1/device-management/orgs/{org_id}/products/{product_id}/thing-models/from-template
```

## 3. 服务间交互

### 3.1 设备管理服务 → 设备接入服务
```go
// 设备注册
type DeviceRegisterReq struct {
    DeviceKey    string `json:"device_key"`
    DeviceSecret string `json:"device_secret"`
    Protocol     string `json:"protocol"`
    BrokerURL    string `json:"broker_url"`
    TopicPrefix  string `json:"topic_prefix"`
}

// 指令下发
type CommandSendReq struct {
    DeviceKey    string                 `json:"device_key"`
    ServiceID    string                 `json:"service_id"`
    InputParams  map[string]interface{} `json:"input_params"`
    Timeout      int                    `json:"timeout"`
}
```

### 3.2 设备接入服务 → 设备管理服务
```go
// 设备状态更新
type DeviceStatusUpdateReq struct {
    DeviceKey    string    `json:"device_key"`
    Status       int       `json:"status"`
    OnlineTime   time.Time `json:"online_time"`
    OfflineTime  time.Time `json:"offline_time"`
}

// 设备数据上报
type DeviceDataReportReq struct {
    DeviceKey    string                 `json:"device_key"`
    Properties   map[string]interface{} `json:"properties"`
    Events       []DeviceEvent          `json:"events"`
    Timestamp    time.Time              `json:"timestamp"`
}
```

## 4. 数据流设计

### 4.1 设备注册流程
```
1. 设备管理服务：创建设备元数据
2. 设备管理服务：生成设备密钥
3. 设备管理服务：调用设备接入服务注册设备
4. 设备接入服务：建立设备连接
5. 设备接入服务：返回连接状态
```

### 4.2 指令下发流程
```
1. 设备管理服务：基于物模型创建指令
2. 设备管理服务：调用设备接入服务发送指令
3. 设备接入服务：向设备发送指令
4. 设备接入服务：接收设备响应
5. 设备接入服务：回调设备管理服务更新指令状态
```

### 4.3 数据上报流程
```
1. 设备接入服务：接收设备数据
2. 设备接入服务：调用设备管理服务存储数据
3. 设备管理服务：验证数据格式（基于物模型）
4. 设备管理服务：存储属性值和事件
5. 设备管理服务：触发相关业务逻辑
```

## 5. 优势总结

### 5.1 物模型在设备管理服务的优势
- **业务完整性**：设备全生命周期管理
- **数据一致性**：避免跨服务数据同步
- **简化架构**：减少服务间依赖
- **开发效率**：统一的技术栈和开发团队

### 5.2 服务职责清晰
- **设备管理服务**：业务管理、元数据、配置
- **设备接入服务**：通信、连接、实时性
- **身份认证服务**：用户、权限、组织

这样的架构设计既保证了职责清晰，又避免了过度拆分带来的复杂性。 