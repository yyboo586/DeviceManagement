- 我在实现一个IOT管理平台，支持多租户。
- 怎么控制设备的访问权限, 比如用户A只能操作部分设备, 租户管理员可以查看该租户的所有设备。

- 数据隔离
  - 每个租户的数据(设备、用户、角色、权限)必须物理隔离或者逻辑隔离。
- 最小权限
  - 用户只能访问执行其任务绝对必须的资源。
- 权限模型
- 精细控制点

- 基于角色的访问控制
  - 使用 RBAC 作为基础模型，结合 ABAC 实现细粒度控制。
- 集中式策略执行点
  - 在关键入口点统一执行权限检查。

# 定时任务时间配置使用说明

## 概述

本系统提供了一套灵活的时间配置机制，允许用户通过结构化的配置来定义定时任务的执行时间，系统会自动将其转换为标准的cron表达式。

## 时间配置结构

### TimeUnitConfig 结构

每个时间单位（分钟、小时、日、月、周）都使用 `TimeUnitConfig` 结构来配置：

```go
type TimeUnitConfig struct {
    Type           string `json:"type"`           // 表达式类型
    SpecificValues []int  `json:"specific_values"` // 特定值列表
    Start          int    `json:"start"`          // 起始值
    End            int    `json:"end"`            // 结束值
    Step           int    `json:"step"`           // 步长
}
```

### 支持的表达式类型

#### 1. all - 全匹配
- **描述**: 表示该时间单位的所有值
- **示例**: `{"type": "all"}`
- **生成的cron**: `*`

#### 2. specific - 特定值
- **描述**: 指定离散的特定值
- **示例**: `{"type": "specific", "specific_values": [1, 3, 5]}`
- **生成的cron**: `1,3,5`

#### 3. range - 连续范围
- **描述**: 指定从起始值到结束值的连续范围
- **示例**: `{"type": "range", "start": 10, "end": 20}`
- **生成的cron**: `10-20`

#### 4. interval - 间隔步长
- **描述**: 在指定范围内按步长间隔执行
- **示例**: `{"type": "interval", "start": 0, "step": 5}`
- **生成的cron**: `*/5`

#### 5. special - 特殊符号
- **描述**: 支持特殊的时间符号（简化实现）
- **示例**: `{"type": "special", "start": 30}`
- **生成的cron**: `30`

## 使用示例

### 1. 每分钟执行

```json
{
  "name": "每分钟任务",
  "org_id": "your-org-id",
  "time_config": {
    "minute": {"type": "all"},
    "hour": {"type": "all"},
    "day": {"type": "all"},
    "month": {"type": "all"},
    "week": {"type": "all"}
  }
}
```

**生成的cron表达式**: `* * * * *`

### 2. 每5分钟执行

```json
{
  "name": "每5分钟任务",
  "org_id": "your-org-id",
  "time_config": {
    "minute": {"type": "interval", "start": 0, "step": 5},
    "hour": {"type": "all"},
    "day": {"type": "all"},
    "month": {"type": "all"},
    "week": {"type": "all"}
  }
}
```

**生成的cron表达式**: `*/5 * * * *`

### 3. 每小时执行

```json
{
  "name": "每小时任务",
  "org_id": "your-org-id",
  "time_config": {
    "minute": {"type": "specific", "specific_values": [0]},
    "hour": {"type": "all"},
    "day": {"type": "all"},
    "month": {"type": "all"},
    "week": {"type": "all"}
  }
}
```

**生成的cron表达式**: `0 * * * *`

### 4. 每天凌晨2点执行

```json
{
  "name": "每日凌晨任务",
  "org_id": "your-org-id",
  "time_config": {
    "minute": {"type": "specific", "specific_values": [0]},
    "hour": {"type": "specific", "specific_values": [2]},
    "day": {"type": "all"},
    "month": {"type": "all"},
    "week": {"type": "all"}
  }
}
```

**生成的cron表达式**: `0 2 * * *`

### 5. 每周一和周三的上午9点执行

```json
{
  "name": "工作日任务",
  "org_id": "your-org-id",
  "time_config": {
    "minute": {"type": "specific", "specific_values": [0]},
    "hour": {"type": "specific", "specific_values": [9]},
    "day": {"type": "all"},
    "month": {"type": "all"},
    "week": {"type": "specific", "specific_values": [1, 3]}
  }
}
```

**生成的cron表达式**: `0 9 * * 1,3`

### 6. 在30-45分钟之间执行

```json
{
  "name": "时间范围任务",
  "org_id": "your-org-id",
  "time_config": {
    "minute": {"type": "range", "start": 30, "end": 45},
    "hour": {"type": "all"},
    "day": {"type": "all"},
    "month": {"type": "all"},
    "week": {"type": "all"}
  }
}
```

**生成的cron表达式**: `30-45 * * * *`

### 7. 在1-10分钟内每2分钟执行一次

```json
{
  "name": "间隔范围任务",
  "org_id": "your-org-id",
  "time_config": {
    "minute": {"type": "interval", "start": 1, "end": 10, "step": 2},
    "hour": {"type": "all"},
    "day": {"type": "all"},
    "month": {"type": "all"},
    "week": {"type": "all"}
  }
}
```

**生成的cron表达式**: `1-10/2 * * * *`

## 时间单位范围限制

| 时间单位 | 最小值 | 最大值 | 说明 |
|---------|--------|--------|------|
| 分钟    | 0      | 59     | 0-59分钟 |
| 小时    | 0      | 23     | 0-23小时 |
| 日      | 1      | 31     | 1-31日 |
| 月      | 1      | 12     | 1-12月 |
| 周      | 0      | 6      | 0=周日, 1=周一, ..., 6=周六 |

## 验证规则

### 1. 必填字段验证
- `name`: 任务名称不能为空
- `org_id`: 组织ID不能为空
- `time_config`: 时间配置不能为空

### 2. 时间配置验证
- 每个时间单位的值必须在指定范围内
- 范围类型的起始值不能大于结束值
- 间隔类型的步长必须大于0
- 特定值列表不能为空

### 3. Cron表达式验证
- 必须包含5个字段（分钟 小时 日 月 周）
- 每个字段的值必须在有效范围内
- 支持 `*`、`*/N`、`N`、`N-M`、`N-M/Step` 等格式

## 错误处理

系统会提供详细的错误信息，帮助用户快速定位问题：

- **时间配置解析失败**: 检查时间配置的格式和值
- **cron表达式验证失败**: 检查生成的cron表达式是否有效
- **字段验证失败**: 检查必填字段和值范围

## 最佳实践

### 1. 配置建议
- 使用 `all` 类型表示不限制的时间单位
- 使用 `specific` 类型指定精确的执行时间
- 使用 `interval` 类型实现定期执行
- 使用 `range` 类型指定时间范围

### 2. 性能考虑
- 避免过于复杂的cron表达式
- 合理设置执行间隔，避免过于频繁
- 考虑业务高峰期的执行时间

### 3. 维护性
- 使用有意义的任务名称
- 添加适当的备注说明
- 定期检查和更新任务配置

## 总结

这套时间配置系统提供了：
1. **灵活性**: 支持多种时间配置模式
2. **易用性**: 结构化的配置，易于理解和维护
3. **可靠性**: 完善的验证机制，确保配置正确
4. **标准化**: 自动生成标准的cron表达式

通过合理使用这些配置选项，可以轻松创建各种复杂的定时任务调度策略。 